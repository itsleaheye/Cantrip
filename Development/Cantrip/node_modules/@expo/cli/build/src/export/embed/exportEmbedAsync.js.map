{"version":3,"sources":["../../../../src/export/embed/exportEmbedAsync.ts"],"sourcesContent":["/**\n * Copyright Â© 2023 650 Industries.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport { getConfig } from '@expo/config';\nimport fs from 'fs';\nimport { sync as globSync } from 'glob';\nimport Server from 'metro/src/Server';\nimport output from 'metro/src/shared/output/bundle';\nimport type { BundleOptions } from 'metro/src/shared/types';\nimport path from 'path';\n\nimport { Options } from './resolveOptions';\nimport { isExecutingFromXcodebuild, logMetroErrorInXcode } from './xcodeCompilerLogger';\nimport { Log } from '../../log';\nimport { loadMetroConfigAsync } from '../../start/server/metro/instantiateMetro';\nimport { getMetroDirectBundleOptionsForExpoConfig } from '../../start/server/middleware/metroOptions';\nimport { stripAnsi } from '../../utils/ansi';\nimport { removeAsync } from '../../utils/dir';\nimport { setNodeEnv } from '../../utils/nodeEnv';\nimport { profile } from '../../utils/profile';\nimport { isEnableHermesManaged } from '../exportHermes';\nimport { getAssets } from '../fork-bundleAsync';\nimport { persistMetroAssetsAsync } from '../persistMetroAssets';\n\nconst debug = require('debug')('expo:export:embed');\n\nfunction guessCopiedAppleBundlePath(bundleOutput: string) {\n  // Ensure the path is familiar before guessing.\n  if (!bundleOutput.match(/\\/Xcode\\/DerivedData\\/.*\\/Build\\/Products\\//)) {\n    debug('Bundling to non-standard location:', bundleOutput);\n    return false;\n  }\n  const bundleName = path.basename(bundleOutput);\n  const bundleParent = path.dirname(bundleOutput);\n  const possiblePath = globSync(path.join(bundleParent, `*.app/${bundleName}`), {\n    // bundle identifiers can start with dots.\n    dot: true,\n  })[0];\n  debug('Possible path for previous bundle:', possiblePath);\n  return possiblePath;\n}\n\nexport async function exportEmbedAsync(projectRoot: string, options: Options) {\n  setNodeEnv(options.dev ? 'development' : 'production');\n  require('@expo/env').load(projectRoot);\n\n  // Ensure we delete the old bundle to trigger a failure if the bundle cannot be created.\n  await removeAsync(options.bundleOutput);\n\n  // The iOS bundle is copied in to the Xcode project, so we need to remove the old one\n  // to prevent Xcode from loading the old one after a build failure.\n  if (options.platform === 'ios') {\n    const previousPath = guessCopiedAppleBundlePath(options.bundleOutput);\n    if (previousPath && fs.existsSync(previousPath)) {\n      debug('Removing previous iOS bundle:', previousPath);\n      await removeAsync(previousPath);\n    }\n  }\n\n  const { bundle, assets } = await exportEmbedBundleAndAssetsAsync(projectRoot, options);\n\n  fs.mkdirSync(path.dirname(options.bundleOutput), { recursive: true, mode: 0o755 });\n\n  // Persist bundle and source maps.\n  await Promise.all([\n    output.save(bundle, options, Log.log),\n    // NOTE(EvanBacon): This may need to be adjusted in the future if want to support baseUrl on native\n    // platforms when doing production embeds (unlikely).\n    options.assetsDest\n      ? persistMetroAssetsAsync(assets, {\n          platform: options.platform,\n          outputDirectory: options.assetsDest,\n          iosAssetCatalogDirectory: options.assetCatalogDest,\n        })\n      : null,\n  ]);\n}\n\nexport async function createMetroServerAndBundleRequestAsync(\n  projectRoot: string,\n  options: Pick<\n    Options,\n    | 'maxWorkers'\n    | 'config'\n    | 'platform'\n    | 'sourcemapOutput'\n    | 'sourcemapUseAbsolutePath'\n    | 'entryFile'\n    | 'minify'\n    | 'dev'\n    | 'resetCache'\n    | 'unstableTransformProfile'\n  >\n): Promise<{ server: Server; bundleRequest: BundleOptions }> {\n  const exp = getConfig(projectRoot, { skipSDKVersionRequirement: true }).exp;\n\n  // TODO: This is slow ~40ms\n  const { config } = await loadMetroConfigAsync(\n    projectRoot,\n    {\n      // TODO: This is always enabled in the native script and there's no way to disable it.\n      resetCache: options.resetCache,\n\n      maxWorkers: options.maxWorkers,\n      config: options.config,\n    },\n    {\n      exp,\n      isExporting: true,\n      getMetroBundler() {\n        return server.getBundler().getBundler();\n      },\n    }\n  );\n\n  const isHermes = isEnableHermesManaged(exp, options.platform);\n\n  let sourceMapUrl = options.sourcemapOutput;\n  if (sourceMapUrl && !options.sourcemapUseAbsolutePath) {\n    sourceMapUrl = path.basename(sourceMapUrl);\n  }\n\n  const bundleRequest = {\n    ...Server.DEFAULT_BUNDLE_OPTIONS,\n    ...getMetroDirectBundleOptionsForExpoConfig(projectRoot, exp, {\n      splitChunks: false,\n      mainModuleName: resolveRealEntryFilePath(projectRoot, options.entryFile),\n      platform: options.platform,\n      minify: options.minify,\n      mode: options.dev ? 'development' : 'production',\n      engine: isHermes ? 'hermes' : undefined,\n      bytecode: isHermes,\n      isExporting: true,\n    }),\n    sourceMapUrl,\n    unstable_transformProfile: (options.unstableTransformProfile ||\n      (isHermes ? 'hermes-stable' : 'default')) as BundleOptions['unstable_transformProfile'],\n  };\n\n  const server = new Server(config, {\n    watch: false,\n  });\n\n  return { server, bundleRequest };\n}\n\nexport async function exportEmbedBundleAndAssetsAsync(\n  projectRoot: string,\n  options: Options\n): Promise<{\n  bundle: Awaited<ReturnType<Server['build']>>;\n  assets: Awaited<ReturnType<typeof getAssets>>;\n}> {\n  const { server, bundleRequest } = await createMetroServerAndBundleRequestAsync(\n    projectRoot,\n    options\n  );\n\n  try {\n    const bundle = await exportEmbedBundleAsync(server, bundleRequest, projectRoot, options);\n    const assets = await exportEmbedAssetsAsync(server, bundleRequest, projectRoot, options);\n    return { bundle, assets };\n  } finally {\n    server.end();\n  }\n}\n\nexport async function exportEmbedBundleAsync(\n  server: Server,\n  bundleRequest: BundleOptions,\n  projectRoot: string,\n  options: Pick<Options, 'platform'>\n) {\n  try {\n    return await profile(\n      server.build.bind(server),\n      'metro-bundle'\n    )({\n      ...bundleRequest,\n      bundleType: 'bundle',\n    });\n  } catch (error: any) {\n    if (isError(error)) {\n      // Log using Xcode error format so the errors are picked up by xcodebuild.\n      // https://developer.apple.com/documentation/xcode/running-custom-scripts-during-a-build#Log-errors-and-warnings-from-your-script\n      if (options.platform === 'ios') {\n        // If the error is about to be presented in Xcode, strip the ansi characters from the message.\n        if ('message' in error && isExecutingFromXcodebuild()) {\n          error.message = stripAnsi(error.message) as string;\n        }\n        logMetroErrorInXcode(projectRoot, error);\n      }\n    }\n    throw error;\n  }\n}\n\nexport async function exportEmbedAssetsAsync(\n  server: Server,\n  bundleRequest: BundleOptions,\n  projectRoot: string,\n  options: Pick<Options, 'platform'>\n) {\n  try {\n    return await getAssets(server, {\n      ...bundleRequest,\n      bundleType: 'todo',\n    });\n  } catch (error: any) {\n    if (isError(error)) {\n      // Log using Xcode error format so the errors are picked up by xcodebuild.\n      // https://developer.apple.com/documentation/xcode/running-custom-scripts-during-a-build#Log-errors-and-warnings-from-your-script\n      if (options.platform === 'ios') {\n        // If the error is about to be presented in Xcode, strip the ansi characters from the message.\n        if ('message' in error && isExecutingFromXcodebuild()) {\n          error.message = stripAnsi(error.message) as string;\n        }\n        logMetroErrorInXcode(projectRoot, error);\n      }\n    }\n    throw error;\n  }\n}\n\nfunction isError(error: any): error is Error {\n  return error instanceof Error;\n}\n\n/**\n * This is a workaround for Metro not resolving entry file paths to their real location.\n * When running exports through `eas build --local` on macOS, the `/var/folders` path is used instead of `/private/var/folders`.\n *\n * See: https://github.com/expo/expo/issues/28890\n */\nfunction resolveRealEntryFilePath(projectRoot: string, entryFile: string): string {\n  if (projectRoot.startsWith('/private/var') && entryFile.startsWith('/var')) {\n    return fs.realpathSync(entryFile);\n  }\n\n  return entryFile;\n}\n"],"names":["exportEmbedAsync","createMetroServerAndBundleRequestAsync","exportEmbedBundleAndAssetsAsync","exportEmbedBundleAsync","exportEmbedAssetsAsync","debug","require","guessCopiedAppleBundlePath","bundleOutput","match","bundleName","path","basename","bundleParent","dirname","possiblePath","globSync","join","dot","projectRoot","options","setNodeEnv","dev","load","removeAsync","platform","previousPath","fs","existsSync","bundle","assets","mkdirSync","recursive","mode","Promise","all","output","save","Log","log","assetsDest","persistMetroAssetsAsync","outputDirectory","iosAssetCatalogDirectory","assetCatalogDest","exp","getConfig","skipSDKVersionRequirement","config","loadMetroConfigAsync","resetCache","maxWorkers","isExporting","getMetroBundler","server","getBundler","isHermes","isEnableHermesManaged","sourceMapUrl","sourcemapOutput","sourcemapUseAbsolutePath","bundleRequest","Server","DEFAULT_BUNDLE_OPTIONS","getMetroDirectBundleOptionsForExpoConfig","splitChunks","mainModuleName","resolveRealEntryFilePath","entryFile","minify","engine","undefined","bytecode","unstable_transformProfile","unstableTransformProfile","watch","end","profile","build","bind","bundleType","error","isError","isExecutingFromXcodebuild","message","stripAnsi","logMetroErrorInXcode","getAssets","Error","startsWith","realpathSync"],"mappings":"AAAA;;;;;CAKC,GACD;;;;;;;;;;;IAuCsBA,gBAAgB,MAAhBA,gBAAgB;IAoChBC,sCAAsC,MAAtCA,sCAAsC;IAoEtCC,+BAA+B,MAA/BA,+BAA+B;IAqB/BC,sBAAsB,MAAtBA,sBAAsB;IA8BtBC,sBAAsB,MAAtBA,sBAAsB;;;yBAlMlB,cAAc;;;;;;;8DACzB,IAAI;;;;;;;yBACc,MAAM;;;;;;;8DACpB,kBAAkB;;;;;;;8DAClB,gCAAgC;;;;;;;8DAElC,MAAM;;;;;;qCAGyC,uBAAuB;qBACnE,WAAW;kCACM,2CAA2C;8BACvB,4CAA4C;sBAC3E,kBAAkB;qBAChB,iBAAiB;yBAClB,qBAAqB;yBACxB,qBAAqB;8BACP,iBAAiB;iCAC7B,qBAAqB;oCACP,uBAAuB;;;;;;AAE/D,MAAMC,KAAK,GAAGC,OAAO,CAAC,OAAO,CAAC,CAAC,mBAAmB,CAAC,AAAC;AAEpD,SAASC,0BAA0B,CAACC,YAAoB,EAAE;IACxD,+CAA+C;IAC/C,IAAI,CAACA,YAAY,CAACC,KAAK,+CAA+C,EAAE;QACtEJ,KAAK,CAAC,oCAAoC,EAAEG,YAAY,CAAC,CAAC;QAC1D,OAAO,KAAK,CAAC;IACf,CAAC;IACD,MAAME,UAAU,GAAGC,KAAI,EAAA,QAAA,CAACC,QAAQ,CAACJ,YAAY,CAAC,AAAC;IAC/C,MAAMK,YAAY,GAAGF,KAAI,EAAA,QAAA,CAACG,OAAO,CAACN,YAAY,CAAC,AAAC;IAChD,MAAMO,YAAY,GAAGC,IAAAA,KAAQ,EAAA,KAAA,EAACL,KAAI,EAAA,QAAA,CAACM,IAAI,CAACJ,YAAY,EAAE,CAAC,MAAM,EAAEH,UAAU,CAAC,CAAC,CAAC,EAAE;QAC5E,0CAA0C;QAC1CQ,GAAG,EAAE,IAAI;KACV,CAAC,CAAC,CAAC,CAAC,AAAC;IACNb,KAAK,CAAC,oCAAoC,EAAEU,YAAY,CAAC,CAAC;IAC1D,OAAOA,YAAY,CAAC;AACtB,CAAC;AAEM,eAAef,gBAAgB,CAACmB,WAAmB,EAAEC,OAAgB,EAAE;IAC5EC,IAAAA,QAAU,WAAA,EAACD,OAAO,CAACE,GAAG,GAAG,aAAa,GAAG,YAAY,CAAC,CAAC;IACvDhB,OAAO,CAAC,WAAW,CAAC,CAACiB,IAAI,CAACJ,WAAW,CAAC,CAAC;IAEvC,wFAAwF;IACxF,MAAMK,IAAAA,IAAW,YAAA,EAACJ,OAAO,CAACZ,YAAY,CAAC,CAAC;IAExC,qFAAqF;IACrF,mEAAmE;IACnE,IAAIY,OAAO,CAACK,QAAQ,KAAK,KAAK,EAAE;QAC9B,MAAMC,YAAY,GAAGnB,0BAA0B,CAACa,OAAO,CAACZ,YAAY,CAAC,AAAC;QACtE,IAAIkB,YAAY,IAAIC,GAAE,EAAA,QAAA,CAACC,UAAU,CAACF,YAAY,CAAC,EAAE;YAC/CrB,KAAK,CAAC,+BAA+B,EAAEqB,YAAY,CAAC,CAAC;YACrD,MAAMF,IAAAA,IAAW,YAAA,EAACE,YAAY,CAAC,CAAC;QAClC,CAAC;IACH,CAAC;IAED,MAAM,EAAEG,MAAM,CAAA,EAAEC,MAAM,CAAA,EAAE,GAAG,MAAM5B,+BAA+B,CAACiB,WAAW,EAAEC,OAAO,CAAC,AAAC;IAEvFO,GAAE,EAAA,QAAA,CAACI,SAAS,CAACpB,KAAI,EAAA,QAAA,CAACG,OAAO,CAACM,OAAO,CAACZ,YAAY,CAAC,EAAE;QAAEwB,SAAS,EAAE,IAAI;QAAEC,IAAI,EAAE,GAAK;KAAE,CAAC,CAAC;IAEnF,kCAAkC;IAClC,MAAMC,OAAO,CAACC,GAAG,CAAC;QAChBC,OAAM,EAAA,QAAA,CAACC,IAAI,CAACR,MAAM,EAAET,OAAO,EAAEkB,IAAG,IAAA,CAACC,GAAG,CAAC;QACrC,mGAAmG;QACnG,qDAAqD;QACrDnB,OAAO,CAACoB,UAAU,GACdC,IAAAA,mBAAuB,wBAAA,EAACX,MAAM,EAAE;YAC9BL,QAAQ,EAAEL,OAAO,CAACK,QAAQ;YAC1BiB,eAAe,EAAEtB,OAAO,CAACoB,UAAU;YACnCG,wBAAwB,EAAEvB,OAAO,CAACwB,gBAAgB;SACnD,CAAC,GACF,IAAI;KACT,CAAC,CAAC;AACL,CAAC;AAEM,eAAe3C,sCAAsC,CAC1DkB,WAAmB,EACnBC,OAYC,EAC0D;IAC3D,MAAMyB,GAAG,GAAGC,IAAAA,OAAS,EAAA,UAAA,EAAC3B,WAAW,EAAE;QAAE4B,yBAAyB,EAAE,IAAI;KAAE,CAAC,CAACF,GAAG,AAAC;IAE5E,2BAA2B;IAC3B,MAAM,EAAEG,MAAM,CAAA,EAAE,GAAG,MAAMC,IAAAA,iBAAoB,qBAAA,EAC3C9B,WAAW,EACX;QACE,sFAAsF;QACtF+B,UAAU,EAAE9B,OAAO,CAAC8B,UAAU;QAE9BC,UAAU,EAAE/B,OAAO,CAAC+B,UAAU;QAC9BH,MAAM,EAAE5B,OAAO,CAAC4B,MAAM;KACvB,EACD;QACEH,GAAG;QACHO,WAAW,EAAE,IAAI;QACjBC,eAAe,IAAG;YAChB,OAAOC,MAAM,CAACC,UAAU,EAAE,CAACA,UAAU,EAAE,CAAC;QAC1C,CAAC;KACF,CACF,AAAC;IAEF,MAAMC,QAAQ,GAAGC,IAAAA,aAAqB,sBAAA,EAACZ,GAAG,EAAEzB,OAAO,CAACK,QAAQ,CAAC,AAAC;IAE9D,IAAIiC,YAAY,GAAGtC,OAAO,CAACuC,eAAe,AAAC;IAC3C,IAAID,YAAY,IAAI,CAACtC,OAAO,CAACwC,wBAAwB,EAAE;QACrDF,YAAY,GAAG/C,KAAI,EAAA,QAAA,CAACC,QAAQ,CAAC8C,YAAY,CAAC,CAAC;IAC7C,CAAC;IAED,MAAMG,aAAa,GAAG;QACpB,GAAGC,OAAM,EAAA,QAAA,CAACC,sBAAsB;QAChC,GAAGC,IAAAA,aAAwC,yCAAA,EAAC7C,WAAW,EAAE0B,GAAG,EAAE;YAC5DoB,WAAW,EAAE,KAAK;YAClBC,cAAc,EAAEC,wBAAwB,CAAChD,WAAW,EAAEC,OAAO,CAACgD,SAAS,CAAC;YACxE3C,QAAQ,EAAEL,OAAO,CAACK,QAAQ;YAC1B4C,MAAM,EAAEjD,OAAO,CAACiD,MAAM;YACtBpC,IAAI,EAAEb,OAAO,CAACE,GAAG,GAAG,aAAa,GAAG,YAAY;YAChDgD,MAAM,EAAEd,QAAQ,GAAG,QAAQ,GAAGe,SAAS;YACvCC,QAAQ,EAAEhB,QAAQ;YAClBJ,WAAW,EAAE,IAAI;SAClB,CAAC;QACFM,YAAY;QACZe,yBAAyB,EAAGrD,OAAO,CAACsD,wBAAwB,IAC1D,CAAClB,QAAQ,GAAG,eAAe,GAAG,SAAS,CAAC;KAC3C,AAAC;IAEF,MAAMF,MAAM,GAAG,IAAIQ,CAAAA,OAAM,EAAA,CAAA,QAAA,CAACd,MAAM,EAAE;QAChC2B,KAAK,EAAE,KAAK;KACb,CAAC,AAAC;IAEH,OAAO;QAAErB,MAAM;QAAEO,aAAa;KAAE,CAAC;AACnC,CAAC;AAEM,eAAe3D,+BAA+B,CACnDiB,WAAmB,EACnBC,OAAgB,EAIf;IACD,MAAM,EAAEkC,MAAM,CAAA,EAAEO,aAAa,CAAA,EAAE,GAAG,MAAM5D,sCAAsC,CAC5EkB,WAAW,EACXC,OAAO,CACR,AAAC;IAEF,IAAI;QACF,MAAMS,MAAM,GAAG,MAAM1B,sBAAsB,CAACmD,MAAM,EAAEO,aAAa,EAAE1C,WAAW,EAAEC,OAAO,CAAC,AAAC;QACzF,MAAMU,MAAM,GAAG,MAAM1B,sBAAsB,CAACkD,MAAM,EAAEO,aAAa,EAAE1C,WAAW,EAAEC,OAAO,CAAC,AAAC;QACzF,OAAO;YAAES,MAAM;YAAEC,MAAM;SAAE,CAAC;IAC5B,SAAU;QACRwB,MAAM,CAACsB,GAAG,EAAE,CAAC;IACf,CAAC;AACH,CAAC;AAEM,eAAezE,sBAAsB,CAC1CmD,MAAc,EACdO,aAA4B,EAC5B1C,WAAmB,EACnBC,OAAkC,EAClC;IACA,IAAI;QACF,OAAO,MAAMyD,IAAAA,QAAO,QAAA,EAClBvB,MAAM,CAACwB,KAAK,CAACC,IAAI,CAACzB,MAAM,CAAC,EACzB,cAAc,CACf,CAAC;YACA,GAAGO,aAAa;YAChBmB,UAAU,EAAE,QAAQ;SACrB,CAAC,CAAC;IACL,EAAE,OAAOC,KAAK,EAAO;QACnB,IAAIC,OAAO,CAACD,KAAK,CAAC,EAAE;YAClB,0EAA0E;YAC1E,iIAAiI;YACjI,IAAI7D,OAAO,CAACK,QAAQ,KAAK,KAAK,EAAE;gBAC9B,8FAA8F;gBAC9F,IAAI,SAAS,IAAIwD,KAAK,IAAIE,IAAAA,oBAAyB,0BAAA,GAAE,EAAE;oBACrDF,KAAK,CAACG,OAAO,GAAGC,IAAAA,KAAS,UAAA,EAACJ,KAAK,CAACG,OAAO,CAAC,AAAU,CAAC;gBACrD,CAAC;gBACDE,IAAAA,oBAAoB,qBAAA,EAACnE,WAAW,EAAE8D,KAAK,CAAC,CAAC;YAC3C,CAAC;QACH,CAAC;QACD,MAAMA,KAAK,CAAC;IACd,CAAC;AACH,CAAC;AAEM,eAAe7E,sBAAsB,CAC1CkD,MAAc,EACdO,aAA4B,EAC5B1C,WAAmB,EACnBC,OAAkC,EAClC;IACA,IAAI;QACF,OAAO,MAAMmE,IAAAA,gBAAS,UAAA,EAACjC,MAAM,EAAE;YAC7B,GAAGO,aAAa;YAChBmB,UAAU,EAAE,MAAM;SACnB,CAAC,CAAC;IACL,EAAE,OAAOC,KAAK,EAAO;QACnB,IAAIC,OAAO,CAACD,KAAK,CAAC,EAAE;YAClB,0EAA0E;YAC1E,iIAAiI;YACjI,IAAI7D,OAAO,CAACK,QAAQ,KAAK,KAAK,EAAE;gBAC9B,8FAA8F;gBAC9F,IAAI,SAAS,IAAIwD,KAAK,IAAIE,IAAAA,oBAAyB,0BAAA,GAAE,EAAE;oBACrDF,KAAK,CAACG,OAAO,GAAGC,IAAAA,KAAS,UAAA,EAACJ,KAAK,CAACG,OAAO,CAAC,AAAU,CAAC;gBACrD,CAAC;gBACDE,IAAAA,oBAAoB,qBAAA,EAACnE,WAAW,EAAE8D,KAAK,CAAC,CAAC;YAC3C,CAAC;QACH,CAAC;QACD,MAAMA,KAAK,CAAC;IACd,CAAC;AACH,CAAC;AAED,SAASC,OAAO,CAACD,KAAU,EAAkB;IAC3C,OAAOA,KAAK,YAAYO,KAAK,CAAC;AAChC,CAAC;AAED;;;;;CAKC,GACD,SAASrB,wBAAwB,CAAChD,WAAmB,EAAEiD,SAAiB,EAAU;IAChF,IAAIjD,WAAW,CAACsE,UAAU,CAAC,cAAc,CAAC,IAAIrB,SAAS,CAACqB,UAAU,CAAC,MAAM,CAAC,EAAE;QAC1E,OAAO9D,GAAE,EAAA,QAAA,CAAC+D,YAAY,CAACtB,SAAS,CAAC,CAAC;IACpC,CAAC;IAED,OAAOA,SAAS,CAAC;AACnB,CAAC"}